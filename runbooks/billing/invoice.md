# Runbook：發票產生失敗 / 發送失敗（Invoice Failure）

目標：快速找出發票失敗原因（生成、PDF 產生、S3 儲存或 Email 送達），並將狀態回復或人工覆核。

步驟：

1. 收集資訊
   - 客戶 ID、訂閱 ID、計費週期、錯誤訊息

2. 檢查產生流程
   - 確認計價引擎 log（或 job queue）是否有異常或重試失敗
   - 檢查使用量資料是否完整

3. 檢查發票產生與儲存
   - 檢查生成 PDF 的 microservice 日誌
   - 確認 PDF 是否已寫入 S3（檢查 S3 key 與 IAM 權限）

4. 檢查發送流程
   - 如果使用 Email provider（如 SES, SendGrid），檢查 provider 回傳錯誤
   - 若使用 Signed URL，檢查產生 URL 的邏輯與過期時間

5. 緩解 / 修復
   - 若是資料缺失，重新匯入使用量紀錄並重跑計價
   - 若是 S3 權限問題，修正 IAM role 或重新上傳檔案
   - 若發送失敗，可手動下載 PDF 並以安全方式寄送給客戶

6. 建立調整與退款流程
   - 若發票金額錯誤，依公司流程建立調整單並通知會計

檢查清單
- 記錄錯誤訊息、相關 log、S3 key、是否已手動發送
